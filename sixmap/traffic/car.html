<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link type="text/css" rel="stylesheet" href="../libs/workshop-resources/ol3/ol.css">
    <link type="text/css" rel="stylesheet" href="../libs/bootstrap/css/bootstrap.min.css">
    <link type="text/css" rel="stylesheet" href="../libs/olMap/olMap.css">

    <script type="text/javascript" src="../libs/workshop-resources/ol3/ol.js"></script>
    <script src="https://openlayers.org/en/v3.20.1/build/ol.js"></script>
    <script type="text/javascript" src="../libs/olMap/jquery-1.9.1.min.js"></script>
    <script type="text/javascript" src="../libs/bootstrap/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../libs/olMap/olMap.js"></script>
    <style>
        .tooltip {
            position: relative;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 4px;
            color: white;
            padding: 4px 8px;
            opacity: 0.7;
            white-space: nowrap;
        }
        .tooltip-measure {
            opacity: 1;
            font-weight: bold;
        }
        .tooltip-static {
            background-color: #ffcc33;
            color: black;
            border: 1px solid white;
        }
        .tooltip-measure:before,
        .tooltip-static:before {
            border-top: 6px solid rgba(0, 0, 0, 0.5);
            border-right: 6px solid transparent;
            border-left: 6px solid transparent;
            content: "";
            position: absolute;
            bottom: -6px;
            margin-left: -7px;
            left: 50%;
        }
        .tooltip-static:before {
            border-top-color: #ffcc33;
        }    </style>
</head>
<body>
<div id="map"></div>
<div id="buttongroup" style="position: absolute;bottom: 200px;right: 100px">
    <input type="button" id="startMonitor" value="模拟监控">&nbsp &nbsp
    <input type="button" id="startTrack" value="历史轨迹">
</div>
<div id="map-measure" style="position: absolute;top: 100px;right: 100px">
    <input type="checkbox" class="map-measuretool" >
    <label>测距</label>
</div>
</body>
<script>
    var olMap = new OLMap(document.getElementById('map'));
    olMap.initialize();
    olMap.setstylePolyLineCommon(2,'#ffcc33',999);

    var urlImgs = '../libs/olMap/imgs/car.png';

    var routeCoords = [
        [109.973127, 27.555605], [109.974249, 27.555266], [109.975156, 27.555109], [109.976847, 27.554990],
        [109.978988, 27.554741], [109.983139, 27.553867], [109.986163, 27.554034], [109.987687, 27.554227],
        [109.988405, 27.554461], [109.988994, 27.554742], [109.991110, 27.556210], [109.993082, 27.557657],
        [109.993778, 27.558069], [109.994725, 27.558443], [109.995978, 27.558728]
    ];

    //初始化车辆位置
    var iMonitoring = olMap.initMonitoring(routeCoords[0], '湘A·00001', urlImgs);

    $('#buttongroup').on('click', function (e) {
        var target = e.target;
        var id = target.id;
        if (id == 'startMonitor') {
            //监控车辆行驶轨迹
            olMap.stopMonitoring(iMonitoring);
            iMonitoring = olMap.initMonitoring(routeCoords[0], '湘A·00001', urlImgs);
            olMap.startMonitoring(iMonitoring, routeCoords);
        }
        if (id == 'startTrack') {
            olMap.stopMonitoring(iMonitoring);
            iMonitoring = olMap.initMonitoring(routeCoords[0], '湘A·00001', urlImgs);
            iMonitoring = olMap.startTrack(iMonitoring, routeCoords);
        }
    })



    //检测checked状态
    var sketch;
    var draw;
    var measureTooltipElement;
    var measureTooltip;
    //测距交互
    var source=new ol.source.Vector();
    var vectorLayer=new ol.layer.Vector({
        source:source,
        style:new ol.style.Style({
        fill: new ol.style.Fill({
            color: 'rgba(255, 255, 255, 0.2)'
        }),
        stroke: new ol.style.Stroke({
            color: '#ffcc33',
            width: 2
        }),
        image: new ol.style.Circle({
            radius: 7,
            fill: new ol.style.Fill({
                color: '#ffcc33'
            })
        })
    })
    });
    vectorLayer.setMap(olMap.map);
    //source必须和vectorLayer的source保持一致，draw和图层是保持关联的的关系，纽带是source，在画图的过程中，显示的是Draw中的style，
    // 而画图完成之后，则显示图层的样式
    function addInteraction() {
        draw = new ol.interaction.Draw({
            source: source,
            type: 'LineString',
            style: new ol.style.Style({
                fill: new ol.style.Fill({
                    color: 'rgba(255, 255, 255, 0.2)'
                }),
                stroke: new ol.style.Stroke({
                    color: 'rgba(0, 0, 0, 0.5)',
                    lineDash: [10, 10],
                    width: 2
                }),
                image: new ol.style.Circle({
                    radius: 5,
                    stroke: new ol.style.Stroke({
                        color: 'rgba(0, 0, 0, 0.7)'
                    }),
                    fill: new ol.style.Fill({
                        color: 'rgba(255, 255, 255, 0.2)'
                    })
                })
            })
        });
        olMap.addInteraction(draw);
        createMeasureTooltip();
        var listener;
        draw.on('drawstart', function (evt) {
            sketch = evt.feature;

            var tooltipCoord = evt.coordinate;

            listener = sketch.getGeometry().on('change', function (evt) {
                var geom = evt.target;
                var output;
                if (geom instanceof ol.geom.LineString) {
                    output=formatLength(geom)
                    tooltipCoord=geom.getLastCoordinate();
                }
                measureTooltipElement.innerHTML=output;
                measureTooltip.setPosition(tooltipCoord);
            })
        },this);
        draw.on('drawend',function () {
            measureTooltipElement.className='tooltip tooltip-static';
            measureTooltip.setOffset([0,-7]);
             sketch=null;
            measureTooltipElement=null;
            createMeasureTooltip();
            ol.Observable.unByKey(listener);
        },this)
    }
    //给定线，测量距离
    var formatLength=function(line){
        var length;
        var output;
        length = Math.round(line.getLength() * 100) / 100;
        if (length > 100) {
            output = (Math.round(length / 1000 * 100) / 100) +
                    ' ' + 'km';
        } else {
            output = (Math.round(length * 100) / 100) +
                    ' ' + 'm';
        }
        return output;
    }
    //创建实时测量距离tooltip
    function createMeasureTooltip(){
        if (measureTooltipElement) {
        measureTooltipElement.parentNode.removeChild(measureTooltipElement);
        }
        measureTooltipElement=document.createElement('div');
        measureTooltipElement.className='tooltip tooltip-measure';
        measureTooltip=new ol.Overlay({
            element:measureTooltipElement,
            offset:[0,-15],
            positioning:'bottom-center'
        });
        olMap.map.addOverlay(measureTooltip);
    }
    //停止测距
    $('.map-measuretool').click(function () {
        if (this.checked) {
            addInteraction()
        }
        else {
            olMap.removeInteraction(draw);
            olMap.map.render();
        }

    });



    //iMonitoring = olMap.startMonitoring(iMonitoring, routeCoords);
    //iMonitoring=olMap.startTrack(iMonitoring,routeCoords);
    //停止车辆监控，清除轨迹


</script>
</html>